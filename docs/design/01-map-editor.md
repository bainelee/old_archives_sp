# 01 - 地图编辑器设计文档

## 概述

《旧日档案馆》是一款 2D 视角的基地建设、模拟经营、资源管理游戏，视角与《缺氧》《司辰之书》类似。地图编辑器是游戏最基础的功能模块，用于在引擎中编辑档案馆的室内场景。

---

## 网格系统

- **地图尺寸**：80 × 60 个网格单位
- **坐标系**：以网格为单位进行定位与编辑
- **用途**：所有场景元素的放置、房间划分均基于网格

---

## 一级编辑：底板铺设

在网格中填充底板（Tile），作为场景的基础层。

### 底板类型

| 类型 | 说明 | 交互 |
|------|------|------|
| 墙壁/装饰 | 墙体、装饰物等 | 无交互 |
| 房间底板 | 可供建设房间的地面 | 用于排布基础房间 |

### 编辑功能

- 在网格上绘制/铺设底板
- 切换不同底板类型进行填充
- 支持擦除、替换

---

## 二级编辑：房间区域划分

在一级铺设的底板上，进一步划分功能区域。

### 功能说明

- 在已铺设的**房间底板**上，划出区域
- 为每个区域指定对应的**房间类型**
- 区域与名词解释中的基础房间（如图书室、机房、实验室、宿舍等）对应

### 编辑流程

1. 选择区域绘制工具
2. 在房间底板上框选或绘制区域范围
3. 为区域绑定房间类型（如：哲学文献室、档案馆门卫室等）
4. 区域数据持久化，供后续游戏逻辑使用

---

## 实现层级关系

```
场景
├── 网格层 (80×60)
├── 底板层 (墙壁/装饰 | 房间底板)
└── 区域层 (在房间底板上的房间划分)
```

---

## 已实现

- [x] 网格系统：80×60，每格 20px
- [x] 底板编辑：空 / 墙壁 / 房间底板 三种类型
- [x] 地图保存/加载：可命名、保存到 5 个槽位（`user://maps/slot_N.json`），打开地图从槽位列表选择
- [x] 操作：左键绘制、中键拖拽平移、滚轮缩放
- [x] 单选：点击单格操作（创造或橡皮擦均为单格）
- [x] 框选：拖拽框选范围，释放后批量应用当前工具
- [x] 工具：空 / 墙壁 / 房间底板 / 橡皮擦
- [x] 标尺网格：左侧与顶部显示网格坐标刻度
- [x] 网格对齐开关：开启后镜头移动吸附至网格
- [x] 底板选择与移动：选择状态开启时框选仅选中不填充；选中后移动按钮出现，可拖拽移动选中底板；右键取消选择

## 相关设计文档

- [02 - 房间信息编辑与 room_info.json 同步](./02-room-info-and-json-sync.md)

## 待定事项

- 底板与 room type 的关联规则
- 区域多选、复制、粘贴

## 已实现 - 二级编辑

- [x] 编辑层级切换：底板 / 房间
- [x] 房间框选创建：在房间底板上框选创建房间
- [x] 房间点击选择：单选模式下点击房间进行选择
- [x] 删除房间：选中房间后点击「删除房间」按钮可删除该房间
- [x] 快捷房间尺寸：5×3、10×3、5×7 按钮，按下鼠标后固定尺寸框随鼠标移动，松开创建（遵守有效性校验）
- [x] 房间信息编辑：名称、类型、清理状态、资源列表（可添加/删除条目，每条目含资源类型、资源储量）
- [x] RoomInfo 结构体：id、room_name、rect(size)、room_type、clean_status、resources[]、base_image_path
- [x] 房间数据保存/加载
- [x] 从 room_info.json 导入模板：选中房间后可选择模板填充房间信息
- [x] 地图与 JSON 双向同步：保存地图时，房间信息同步至 room_info.json；从模板导入的房间在编辑后保存也会更新 JSON
- [x] 房间底图：可为房间配置底图，从工程内选择图像（res://），仅显示一张、左上角对齐、不拉伸，超出房间范围裁剪；项目使用最近邻过滤以保持像素图清晰

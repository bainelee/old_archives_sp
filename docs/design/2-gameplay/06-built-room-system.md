# 06 - 已建设房间系统

## 概述

本文档描述房间**建设完成后**的持续运作逻辑：研究区消耗房间存量产出因子、造物区消耗意志产出权限/信息、生活区提供住房、事务所解锁功能等。数值设计见 [01 - 游戏数值系统](../0-values/01-game-values.md) 第 6、7 节。

**前置**：房间须经 [05 - 区域建设功能](05-zone-construction.md) 建设完成，`room.zone_type` 已绑定区域类型。

**核心原则**：房间存量（`room.resources`）**绝不**在建设完成或任意时刻一次性授予玩家，仅通过本系统的持续运作逐步消耗与转化。

---

## 核心概念（策划说明）

### 研究员占用

已建设的房间会**长期占用**研究员在该房间工作。建设完成后研究员**不返还**，直至房间存量耗尽（研究区）或房间被拆除时才释放。

### 研究区 vs 造物区

| 维度 | 研究区 | 造物区 |
|------|--------|--------|
| **房间资源存量** | 有，建设前即存在于 `room.resources`（如哲学文献室 5000 认知因子） | 无基础资源储存 |
| **消耗来源** | 消耗**房间内**的存量 | 消耗**玩家**的资源（意志因子） |
| **产出逻辑** | 持续消耗存量 → 产出因子给玩家 | 持续消耗玩家资源 → 产出因子给玩家 |
| **示例** | 图书室研究区：消耗房间认知存量，产出认知因子 | 案情陈列室（推理室）造物区：消耗玩家意志，产出信息 |

**研究区**：能建设研究区的房间（图书室、机房、资料库、教学室）在清理完成后保留 `room.resources` 存量，建设研究区后按小时逐步消耗这些存量并转化为玩家因子。

**造物区**：能建设造物区的房间（实验室、推理室）通常无存量配置，建设造物区后根据房间类型消耗玩家意志、产出权限或信息；若 room_info 中有存量配置，该存量不参与造物区运作，也不应一次性授予玩家。

---

## 1. 研究区运作

### 1.1 适用房间

- 图书室、机房、资料库、教学室（建设研究区后）

### 1.2 产出逻辑

- **消耗**：房间 `room.resources` 中与产出类型对应的存量
- **产出**：按房间单位数 × 每单位每小时产出，持续增加玩家因子
- **节奏**：每游戏小时结算一次，消耗存量、产出因子

### 1.3 产出速率（1 单位，08 6.1）

| 房间类型 | 产出因子 | 每小时产出 |
|----------|----------|------------|
| 图书室 | 认知 | 5 |
| 机房 | 计算 | 5 |
| 资料库 | 权限 | 10 |
| 教学室 | 意志 | 10 |

公式：`每小时产出 = 房间单位数 × 每单位每小时产出`

### 1.4 存量耗尽

当房间对应类型的存量归零后：

- 研究区**停止产出**
- 房间类型转变为**空房间**（`room_type = EMPTY_ROOM`）
- `zone_type` 归零
- 研究员从「房间工作」中释放

---

## 2. 造物区运作

### 2.1 适用房间

- 实验室、推理室（建设造物区后）

### 2.2 产出逻辑

- **消耗**：玩家意志因子（每单位 15/h）
- **产出**：实验室产出权限、推理室产出信息（每单位 15/h）
- **节奏**：每游戏小时检查意志是否充足；充足则扣除意志、增加产出；不足则**停工**，不产出

### 2.3 产出速率（1 单位，08 7.1）

| 房间类型 | 消耗 | 每小时消耗 | 产出 | 每小时产出 |
|----------|------|------------|------|------------|
| 实验室 | 意志 | 15 | 权限 | 15 |
| 推理室 | 意志 | 15 | 信息 | 15 |

### 2.4 停工与恢复

- 意志不足时：本小时不消耗、不产出
- 意志恢复后：下一小时继续正常运作

**说明**：造物区不消耗 `room.resources`，房间内可能存在的存量（如 room_info.json 中配置）不参与造物区运作，也不应一次性授予玩家。

---

## 3. 暂停研究

### 3.1 适用条件

有**消耗玩家资源**需求的房间（当前为造物区：实验室、推理室）会实时监测玩家的资源存量，以判断是否需要暂停研究。

### 3.2 暂停判定

- **条件**：若玩家当前该类型资源存量**不足**以支撑此房间 **24 小时（一天）** 的消耗，则房间进入**暂停研究**状态
- **公式**：`24 小时消耗 = 房间单位数 × 每单位每小时消耗 × 24`
  - 示例：3 单位推理室，意志消耗 15/单位/h → 24h 需 3×15×24 = 1080 意志
- **节奏**：每帧或每游戏时间刻度实时检查，避免滞后

### 3.3 视觉反馈

暂停研究时：

- 房间**左上角**显示**红色叹号**标记
- 显示文本 **「暂停研究」**（可悬浮 tooltip 或房间内叠加）

### 3.4 恢复条件

- 暂停研究的房间会**实时**检查玩家资源
- 当玩家该类型资源存量 **≥ 24 小时消耗**时，房间自动恢复生产
- 恢复后，红色叹号与「暂停研究」文案隐藏

### 3.5 与造物区现有逻辑的关系

- 原有「意志不足时本小时停工」逻辑可保留（按小时粒度兜底）
- 暂停研究为**预判型**：提前 24 小时警示，减少频繁启停带来的体验波动
- 若实现暂停研究，建议：暂停状态下该房间**不参与**每小时产出结算；恢复后才重新计入

### 3.6 扩展（预留）

若未来新增消耗玩家资源类型的区域（如消耗认知、计算等），可复用本设计：监测对应资源、按 24 小时消耗阈值判定暂停与恢复。

---

## 4. 生活区

### 4.1 适用房间

- 宿舍（建设生活区后）

### 4.2 功能

- **住房**：3 单位宿舍提供 4 住房（08 5.4）
- **住房需求**：1 名研究员需 1 住房

（住房与研究员上限的联动逻辑待后续文档完善）

---

## 5. 事务所区

### 5.1 适用房间

- 事务所遗址

### 5.2 功能

- 建设完成后解锁事务所相关功能
- 具体功能待定

---

## 6. 与清理/建设的边界

### 6.1 资源授予约束

| 时机 | 是否授予 room.resources |
|------|-------------------------|
| 清理完成 | **否**（可建设区域房间的存量保留，供研究区消耗） |
| 建设完成 | **否**（本系统原则：绝不一次性授予） |
| 持续运作 | 研究区每小时消耗存量、产出因子；造物区不涉及 room.resources |

### 6.2 可建设房间列表（清理完成不授予）

- 研究区可建设：图书室、机房、资料库、教学室
- 造物区可建设：实验室、推理室
- 上述房间在清理完成时，`room.resources` **不**授予玩家，由本系统或改造逻辑处理

---

## 7. 数据模型

### 7.1 房间字段

| 字段 | 类型 | 说明 |
|------|------|------|
| zone_type | int | 已建设区域类型（ZoneType 枚举） |
| resources | Array | 存量列表，每项 `{resource_type, resource_amount}` |
| room_type | int | 房间类型；研究区存量耗尽时变为 EMPTY_ROOM |

### 7.2 产出推进

- 按游戏时间（GameTime）每游戏小时推进
- 实现位置：`game_main._process` → `_process_built_room_production`

---

## 8. 实现要点

| 项目 | 说明 |
|------|------|
| 时间推进 | 累积 `game_hours_delta`，满 1 小时处理一次各已建设房间 |
| 研究区 | 查找 room.resources 中匹配 ResourceType 的存量，扣减并增加玩家因子 |
| 造物区 | 检查玩家意志，够则扣意志、加权限/信息；不够则跳过 |
| 存量耗尽 | 研究区存量归零 → `room.room_type = EMPTY_ROOM`，`zone_type = 0`，释放研究员 |
| 暂停研究 | 造物区：每帧检测玩家意志是否 ≥ 24h 消耗；不足则暂停并显示红叹号 |

---

## 9. 待定事项

- [ ] 生活区住房与研究员上限的数值联动
- [ ] 事务所建设完成后的具体功能
- [ ] 房间拆除：已建设房间的拆除、研究员返还
- [ ] 造物区房间的 room.resources 语义（若存在）：是否参与其他逻辑或仅作展示
- [ ] 暂停研究：红叹号图标、文案位置与具体 UI 样式

---

## 10. 相关文档

- [00 - 项目概览](../00-project-overview.md)
- [01 - 游戏数值系统](../0-values/01-game-values.md)（研究区/造物区产出数值）
- [04 - 房间清理系统](04-room-cleanup-system.md)（清理完成与资源授予边界）
- [05 - 区域建设功能](05-zone-construction.md)（建设流程、资源授予约束 2.6）
- [02 - 时间流逝系统](02-time-system.md)

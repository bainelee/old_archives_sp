# 00 - 项目概览与新系统准备

## 概述

本文档对《旧日档案馆》项目进行全面梳理，包括游戏定位、技术架构、已实现功能与数据流，为后续新系统开发提供清晰基线。

---

## 1. 项目定位

**游戏类型**：2D 视角的基地建设、模拟经营、资源管理，视角类似《缺氧》《司辰之书》。

**故事背景**：玩家担任旧日档案馆管理员，依靠「文明的庇佑」对抗暴君莱卡昂的神秘侵蚀。

**核心玩法**：
- 招募研究员 / 调查员，解锁并建设档案馆房间
- 房间类型：研究区、造物区、事务所区、生活区
- 四种因子：认知、计算、意志、权限（对应食物 / 燃料 / 素材 / 建材）
- 档案馆核心消耗计算因子提供庇护，抵抗侵蚀
- 外派调查员获取「真相」等高级货币

**技术栈**：Godot 4.6、Jolt Physics、Forward Plus 渲染。

---

## 2. 项目结构

### 当前实现结构

```
old-archives-sp/
├── scenes/
│   ├── editor/           # 场景编辑器（单独运行，用于编辑地图）
│   └── game/             # 游戏主场景（主运行入口）
├── scripts/
│   ├── editor/           # 场景编辑器脚本
│   └── game/             # 游戏主逻辑
├── datas/                # 数据文件（.gdignore，未被 Godot 导入）
│   └── room_info.json    # 房间模板库（ROOM_001 等）
├── assets/               # 底板纹理、精灵图、UI 素材
├── resources/            # Godot 资源
└── docs/                 # 名词解释、设计文档
```

- **主场景**：已留空（`run/main_scene=""`），不固定运行入口
- **运行当前场景**（F6）：进入当前打开的场景；打开场景编辑器则进编辑器，打开游戏主场景则进游戏

### README 中规划的结构（部分实现）

- `scenes/game/` - 游戏主场景 ✓
- `scripts/game/` - 游戏主逻辑 ✓
- `scripts/core/` - 核心系统（档案馆核心、庇护、侵蚀等）
- `scripts/personnel/` - 人员（研究员、调查员、英杰）
- `scripts/rooms/` - 房间与区域逻辑

---

## 3. 已实现系统：场景编辑器

### 3.1 网格与底板

- **网格**：80×60 格，每格 20px
- **底板类型**：空、墙壁/装饰、房间底板（三者互斥）
- **编辑层级**：底板 / 房间（可切换）
- **操作**：左键绘制、中键平移、滚轮缩放；单选 / 框选 / 选择（可选择底板并移动）

### 3.2 房间编辑

- **房间创建**：在房间底板上框选，或使用快捷尺寸（5×3、10×3、5×7）
- **房间信息**：名称、类型（图书室/实验室/教学室等）、清理状态、描述、资源列表、底图
- **RoomInfo 结构**：`scripts/editor/room_info.gd` 定义 `RoomType`、`ResourceType`、`CleanStatus`

### 3.3 数据流

```
场景编辑器                          存储
────────────────────────────────────────────────────────────
地图槽位 (slot_0..4)  ──load──►  _rooms (RoomInfo[])
_rooms               ──save──►  user://maps/slot_N.json
_rooms               ──同步──►  datas/room_info.json
datas/room_info.json ──导入──►  _rooms（从模板导入）
```

- **地图槽位**：`user://maps/slot_0.json` ~ `slot_4.json`，保存底板 + 房间数据
- **room_info.json**：共享房间模板库；保存地图时根据 `json_room_id` 自动同步；导入模板时反向写入房间

### 3.4 关键文件

| 文件 | 职责 |
|------|------|
| `scripts/editor/scene_editor.gd` | 场景编辑主逻辑、UI、保存/加载、JSON 同步 |
| `scripts/editor/room_info.gd` | RoomInfo 定义、枚举、序列化 |
| `scripts/editor/floor_tile_type.gd` | 底板类型、编辑层级、选择模式 |
| `scripts/editor/scene_editor_ruler.gd` | 标尺/网格坐标显示 |
| `datas/room_info.json` | 房间模板（约 30+ 房间） |
| `.cursor/rules/` | 场景编辑器、房间信息、Git 提交编码规范 |

---

## 4. 游戏内概念（名词解释）

- **因子**：认知/计算/意志/权限，对应食物/燃料/素材/建材
- **货币**：信息（基础）、真相（高级）
- **人员**：研究员（基础劳动力）、调查员（外派）、英杰（特殊单位）
- **房间类型**：档案馆核心、图书室、实验室、教学室、资料库、机房、推理室、事务所遗址、宿舍、空房间
- **庇护等级**：绝境 / 暴露 / 薄弱 / 妥善 / 完美
- **神秘侵蚀**：隐性 / 轻度 / 显性 / 涌动阴霾 / 莱卡昂的暗影

详见 [名词解释](../名词解释.md)。

---

## 5. 待办与可扩展点

设计文档中标注的待定/未实现项：
- 底板与 room type 的关联规则
- 区域多选、复制、粘贴
- **游戏主逻辑**（运行地图、资源、人员、核心、庇护、侵蚀等）尚未实现

---

## 6. 新系统开发建议

1. **明确新系统范围**：例如「游戏主场景」「资源与因子系统」「人员与劳动力」等，以便拆分任务。
2. **复用现有数据**：`room_info.json` 和 `RoomInfo` 可作为游戏运行时的房间数据源。
3. **主场景**：已切换为游戏主场景；场景编辑器仅能单独运行，游戏运行时不可唤出。
4. **架构方向**：考虑 Autoload 单例管理资源、人员、庇护等全局状态。

---

## 相关文档

- [01 - 场景编辑器](01-scene-editor.md)
- [02 - 房间信息与 room_info.json 同步](02-room-info-and-json-sync.md)
- [05 - 庇护/侵蚀 UI](05-shelter-erosion-ui.md)
- [06 - 主 UI 设计概览](06-ui-main-overview.md)
- [名词解释](../名词解释.md)
